<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>반편성 생성기 | Edu Tools</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --soft:#f1f5f9;
      --accent:#e9d5ff;      /* 파스텔 단색 느낌 */
      --accent2:#dbeafe;     /* 아주 옅은 보조 */
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, var(--accent) 0%, transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, var(--accent2) 0%, transparent 55%),
                  var(--bg);
      color:var(--ink);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:22px 16px 56px;}
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand b{letter-spacing:.12em; font-size:12px; color:var(--muted)}
    .brand h1{margin:0; font-size:22px}

    /* 3-line category navigation (cross-site links) */
    .catnav{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      min-width: 280px;
      max-width: 360px;
    }
    @media (max-width: 980px){
      .topbar{align-items:flex-start; flex-direction:column;}
      .catnav{min-width:unset; width:100%;}
    }
    .cat{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, .06);
    }
    .cat .name{
      font-size:13px;
      font-weight:800;
      letter-spacing:-0.01em;
    }
    .cat .meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 175px;
      text-align:right;
    }
    .cat:focus, .cat:hover{
      border-color: rgba(167,139,250,.55);
      box-shadow: 0 0 0 4px rgba(167,139,250,.14), 0 10px 25px rgba(15, 23, 42, .08);
      outline:none;
    }

    .hero{
      background:rgba(255,255,255,.8);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      margin-bottom:14px;
    }
    .hero p{margin:0; color:var(--muted); line-height:1.6}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .sub{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;             /* 라벨-입력 간격 */
      margin-bottom:12px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding:12px 14px;
      min-height:44px;
      line-height:1.3;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
    }
    select{padding-right:44px;}
    textarea{min-height:120px; resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: #a78bfa;
      box-shadow: 0 0 0 4px rgba(167,139,250,.18);
    }

    .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
    button{
      border:none; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--line);
      color:var(--ink);
      font-weight:600;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(233,213,255,.95), rgba(233,213,255,.65));
      border-color: rgba(167,139,250,.55);
    }
    button.ghost{background:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}

    .toggleRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(255,255,255,.6);
    }
    .toggleRow small{color:var(--muted)}
    .seg{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .seg input{display:none}
    .seg label{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .seg input:checked + label{
      color:var(--ink);
      border-color: rgba(167,139,250,.6);
      background: rgba(233,213,255,.6);
    }

    .resultHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .tabs{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-size:12px; cursor:pointer;
    }
    .tab.active{
      background: rgba(219,234,254,.7);
      border-color: rgba(59,130,246,.25);
      color:var(--ink);
    }

    .tables{display:grid; gap:12px}
    .classCard{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
    }
    .classTitle{
      padding:10px 12px;
      background: rgba(233,213,255,.45);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:800;
    }
    .classTitle small{font-weight:600; color:var(--muted)}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      background: rgba(241,245,249,.55);
    }
    tr:last-child td{border-bottom:none}

    .footer{
      margin-top:26px;
      padding:18px 0 26px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(254,242,242,.8);
      color:#991b1b;
      font-size:12px;
      line-height:1.55;
      display:none;
    }
    .ok{
      border-color: rgba(34,197,94,.25);
      background: rgba(240,253,244,.85);
      color:#166534;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <b>EDU TOOLS</b>
        <h1>반편성 생성기</h1>
      </div>

      <!-- 3-line category cross-site navigation -->
      <nav class="catnav" aria-label="카테고리">
        <a class="cat" href="https://school-letter.pages.dev/" target="_blank" rel="noopener">
          <span class="name">가정통신문</span>
          <span class="meta">school-letter.pages.dev</span>
        </a>
        <a class="cat" href="https://money-report.pages.dev/" target="_blank" rel="noopener">
          <span class="name">금전·회계</span>
          <span class="meta">money-report.pages.dev</span>
        </a>
        <a class="cat" href="https://educate1.pages.dev/" target="_blank" rel="noopener">
          <span class="name">교육·평가</span>
          <span class="meta">educate1.pages.dev</span>
        </a>
      </nav>
    </div>

    <div class="hero">
      <p>
        학생 명렬표를 <b>그대로 붙여넣기</b> 하면, 점수/남녀/특성/금지조합/형제·쌍둥이 규칙을 반영해
        <b>자동으로 반편성</b>을 생성합니다. (개인정보는 최소화해서 사용하세요.)
      </p>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <h2>입력</h2>
        <p class="sub">엑셀에서 이름 열만 복사해서 붙여넣으면 됩니다. (줄바꿈 기준 인식)</p>

        <div class="row">
          <div class="field">
            <label>신입생/재학생 선택</label>
            <select id="mode">
              <option value="new">신입생/신규 편성</option>
              <option value="transfer">재학생(전학/전입 포함)</option>
            </select>
          </div>
          <div class="field">
            <label>재학생인 경우 몇학년</label>
            <select id="grade">
              <option value="">선택 안 함</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>몇 반 생성할지 (K)</label>
            <input id="k" type="number" min="2" max="20" value="4" />
          </div>
          <div class="field">
            <label>랜덤 시드(같은 값이면 같은 결과)</label>
            <input id="seed" type="text" placeholder="예: 2026-1" value="2026-1" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>입력 방식</label>
            <select id="inputType">
              <option value="single">전체 명렬표 1개로 입력</option>
              <option value="byClass">기존 반별로 입력(1반/2반/3반…)</option>
            </select>
          </div>
          <div class="field" id="existingCountWrap" style="display:none;">
            <label>기존 몇 개 반의 자료를 넣을까요? (N)</label>
            <input id="existingCount" type="number" min="1" max="20" value="3" />
          </div>
        </div>

        <div id="byClassArea" style="display:none; margin-top:6px;"></div>

        <div class="field">
          <label>학생 명렬표 (줄바꿈으로 구분)</label>
          <textarea id="roster" placeholder="예:
홍길동
김하나(여)
남:박민수
이영희,여"></textarea>
          <div class="hint">팁) 동명이인이 있으면 자동으로 <span class="mono">a/b/c</span>를 붙여 구분합니다.</div>
        </div>

        <div class="row">
          <div class="field">
            <label>남학생 목록 (선택, 줄바꿈)</label>
            <textarea id="boys" placeholder="예:
박민수
홍길동"></textarea>
          </div>
          <div class="field">
            <label>여학생 목록 (선택, 줄바꿈)</label>
            <textarea id="girls" placeholder="예:
김하나
이영희"></textarea>
          </div>
        </div>

        <div class="field">
          <label>점수/등수 (선택) — “이름 점수” 한 줄씩</label>
          <textarea id="scores" placeholder="예:
홍길동 87
김하나 92
박민수 75"></textarea>
          <div class="hint">점수가 없으면 인원/성별/특성 중심으로만 균등화합니다.</div>
        </div>

        <div class="field">
          <label>특성 종류 (콤마로 나열)</label>
          <input id="traitNames" type="text" value="ADHD,기초학력,특수교육대상,상자,교우관계,사춘기" />
          <div class="hint">아래 “특성별 학생 목록”에 이름만 붙여넣으면 체크처럼 반영됩니다.</div>
        </div>

        <div id="traitsArea"></div>

        <div class="field">
          <label>붙으면 안 되는 조합 (한 줄에 1쌍: “이름1 - 이름2”)</label>
          <textarea id="avoidPairs" placeholder="예:
홍길동 - 박민수
김하나 - 이영희"></textarea>
        </div>

        <div class="row">
          <div class="field">
            <label>형제/자매/쌍둥이 그룹 (선택) — “그룹명: 이름1, 이름2 …”</label>
            <textarea id="siblings" placeholder="예:
A가족: 홍길동, 홍길순
쌍둥이1: 김하나, 김하나a"></textarea>
          </div>
          <div class="field">
            <label>형제/쌍둥이 규칙</label>
            <div class="toggleRow">
              <small>같은 반 / 다른 반</small>
              <div class="seg">
                <input type="radio" name="sibRule" id="sibSame" value="same" checked>
                <label for="sibSame">같은 반</label>
                <input type="radio" name="sibRule" id="sibDiff" value="diff">
                <label for="sibDiff">다른 반</label>
                <input type="radio" name="sibRule" id="sibIgnore" value="ignore">
                <label for="sibIgnore">규칙 없음</label>
              </div>
            </div>

            <div class="toggleRow" style="margin-top:10px;">
              <small>우선순위</small>
              <div class="seg">
                <input type="radio" name="priority" id="pScore" value="score" checked>
                <label for="pScore">점수균형 우선</label>
                <input type="radio" name="priority" id="pTrait" value="trait">
                <label for="pTrait">특성균형 우선</label>
                <input type="radio" name="priority" id="pGender" value="gender">
                <label for="pGender">남녀균형 우선</label>
              </div>
            </div>

          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnGenerate">반편성 생성</button>
          <button class="ghost" id="btnExample">예시 입력</button>
          <button id="btnReset">입력 초기화</button>
        </div>

        <div class="warn" id="msg"></div>
      </div>

      <!-- RIGHT: RESULT -->
      <div class="card" id="result">
        <div class="resultHead">
          <div>
            <h2 style="margin:0 0 4px;">생성 결과</h2>
            <div class="hint">복사/다운로드 후 필요하면 다시 “시드”를 바꿔 다른 조합도 만들어보세요.</div>
          </div>
          <div class="btns" style="margin:0;">
            <button id="btnCopy">결과 복사</button>
            <button id="btnCSV">CSV 다운로드</button>
          </div>
        </div>

        <div class="tabs" id="tabs"></div>
        <div id="tables" class="tables"></div>
      </div>
    </div>

    <div class="footer">
      반편성 생성기<br/>
      Copyright © HONGSEOK LEE. All rights reserved.
    </div>
  </div>

<script>
/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
const cleanLine = (s)=>String(s||"").trim();
const splitLines = (t)=>String(t||"").split(/\r?\n/).map(cleanLine).filter(Boolean);
const uniq = (arr)=>Array.from(new Set(arr));

function buildByClassInputs(){
  const area = $("byClassArea");
  const n = Math.max(1, Math.min(20, parseInt($("existingCount")?.value || "1", 10)));

  area.innerHTML = "";
  for (let i=1;i<=n;i++){
    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
      <label>기존 ${i}반 명렬표 (줄바꿈)</label>
      <textarea data-existing-class="${i}" placeholder="예:\n홍길동\n김하나(여)\n남:박민수"></textarea>
    `;
    area.appendChild(div);
  }
}

function readExistingClassRoster(){
  const tas = Array.from(document.querySelectorAll('#byClassArea textarea[data-existing-class]'));
  const all = [];
  for (const ta of tas){
    all.push(...splitLines(ta.value));
  }
  return all;
}

function syncInputTypeUI(){
  const t = $("inputType")?.value || "single";
  const show = (t === "byClass");
  $("existingCountWrap").style.display = show ? "" : "none";
  $("byClassArea").style.display = show ? "" : "none";
  if (show) buildByClassInputs();
}

// UI toggle: single roster vs existing classes
$("inputType").addEventListener("change", syncInputTypeUI);
$("existingCount").addEventListener("input", ()=>{
  if (($("inputType")?.value || "single") === "byClass") buildByClassInputs();
});
syncInputTypeUI();

function hashSeed(str){
  // simple deterministic hash -> int
  let h = 2166136261>>>0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h>>>0;
}
function rng(seedStr){
  // mulberry32
  let a = hashSeed(seedStr);
  return function(){
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function parseNameGender(raw){
  // formats: "홍길동(남)" "홍길동,여" "남:홍길동"
  let s = cleanLine(raw);
  let gender = null;

  const m1 = s.match(/^(남|여)\s*[:：]\s*(.+)$/);
  if (m1){ gender = m1[1]; s = cleanLine(m1[2]); return {name:s, gender}; }

  const m2 = s.match(/^(.+?)[,\t ]+(남|여)$/);
  if (m2){ return {name:cleanLine(m2[1]), gender:m2[2]}; }

  const m3 = s.match(/^(.+?)\s*\((남|여)\)\s*$/);
  if (m3){ return {name:cleanLine(m3[1]), gender:m3[2]}; }

  return {name:s, gender:null};
}
function disambiguateNames(names){
  // same name -> namea, nameb, namec...
  const count = {};
  const out = [];
  for (const n of names){
    count[n] = (count[n]||0)+1;
    if (count[n]===1){ out.push(n); }
    else{
      const suffix = String.fromCharCode(95 + count[n]); // 2->a, 3->b ...
      out.push(n + suffix);
    }
  }
  return out;
}
function normalizeNameMap(students){
  // map baseName -> list of unique ids
  const map = new Map();
  for (const st of students){
    const base = st.baseName;
    if (!map.has(base)) map.set(base, []);
    map.get(base).push(st.id);
  }
  return map;
}
function resolveToIds(name, nameMap){
  // if exact id exists, use it; else if base exists and only one, use it; else null
  if (nameMap.__idSet && nameMap.__idSet.has(name)) return [name];
  if (nameMap.has(name) && nameMap.get(name).length===1) return [nameMap.get(name)[0]];
  // try strip trailing a/b/c (동명이인)
  const base = name.replace(/[a-z]$/,'');
  if (nameMap.has(base) && nameMap.get(base).length===1) return [nameMap.get(base)[0]];
  return null;
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= UI: traits area build ========= */
function buildTraitsArea(){
  const names = splitLines($("traitNames").value.replace(/,/g,"\n"));
  const area = $("traitsArea");
  area.innerHTML = "";
  for (const t of names){
    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
      <label>특성: ${t} (해당 학생 이름만 줄바꿈으로)</label>
      <textarea data-trait="${t}" placeholder="예:\n홍길동\n김하나"></textarea>
    `;
    area.appendChild(div);
  }
}
$("traitNames").addEventListener("input", buildTraitsArea);
buildTraitsArea();

/* ========= Core: parse inputs ========= */
function readInputs(){
  const k = Math.max(2, Math.min(20, parseInt($("k").value||"4",10)));
  const seed = cleanLine($("seed").value) || "seed";
  const priority = document.querySelector('input[name="priority"]:checked')?.value || "score";
  const sibRule = document.querySelector('input[name="sibRule"]:checked')?.value || "same";

  // roster
  let rosterLines = [];
  const inputType = $("inputType") ? $("inputType").value : "single";
  if (inputType === "byClass"){
    rosterLines = readExistingClassRoster();
  } else {
    rosterLines = splitLines($("roster").value);
  }
  if (rosterLines.length < k) throw new Error("학생 명렬표가 너무 적습니다. 최소 반 수(K) 이상 입력해 주세요.");

  // parse roster with optional gender
  const parsed = rosterLines.map(parseNameGender);
  const baseNames = parsed.map(x=>x.name);
  const ids = disambiguateNames(baseNames);

  const students = ids.map((id, i)=>({
    id,
    baseName: parsed[i].name,     // before disambiguation
    display: id,                  // show id (with a/b/c if needed)
    gender: parsed[i].gender,     // 남/여/null
    score: null,
    traits: new Set(),
    sibGroup: null,
    avoid: new Set()
  }));

  // build name map
  const nameMap = normalizeNameMap(students);
  nameMap.__idSet = new Set(students.map(s=>s.id));

  // optional boys/girls lists override
  const boys = new Set(splitLines($("boys").value));
  const girls = new Set(splitLines($("girls").value));

  if (boys.size || girls.size){
    for (const st of students){
      const base = st.baseName;
      const id = st.id;
      if (boys.has(base) || boys.has(id)) st.gender = "남";
      if (girls.has(base) || girls.has(id)) st.gender = "여";
    }
  }

  // scores
  const scoreLines = splitLines($("scores").value);
  for (const line of scoreLines){
    const m = line.match(/^(.+?)\s+(-?\d+(?:\.\d+)?)$/);
    if (!m) continue;
    const nm = cleanLine(m[1]);
    const val = parseFloat(m[2]);
    const ids2 = resolveToIds(nm, nameMap);
    if (!ids2) continue;
    for (const sid of ids2){
      const st = students.find(x=>x.id===sid);
      if (st) st.score = val;
    }
  }

  // traits
  const traitTextareas = Array.from(document.querySelectorAll("#traitsArea textarea"));
  for (const ta of traitTextareas){
    const tname = ta.dataset.trait;
    const names = splitLines(ta.value);
    for (const nm of names){
      const ids2 = resolveToIds(nm, nameMap);
      if (!ids2) continue;
      for (const sid of ids2){
        const st = students.find(x=>x.id===sid);
        if (st) st.traits.add(tname);
      }
    }
  }

  // avoid pairs
  const avoidLines = splitLines($("avoidPairs").value);
  for (const line of avoidLines){
    const parts = line.split("-").map(cleanLine);
    if (parts.length<2) continue;
    const a = parts[0], b = parts[1];
    const ida = resolveToIds(a, nameMap);
    const idb = resolveToIds(b, nameMap);
    if (!ida || !idb) continue;
    for (const x of ida){
      for (const y of idb){
        if (x===y) continue;
        students.find(s=>s.id===x)?.avoid.add(y);
        students.find(s=>s.id===y)?.avoid.add(x);
      }
    }
  }

  // sibling groups
  const sibLines = splitLines($("siblings").value);
  const sibGroups = [];
  for (const line of sibLines){
    const m = line.match(/^(.+?)\s*[:：]\s*(.+)$/);
    if (!m) continue;
    const gname = cleanLine(m[1]);
    const membersRaw = m[2].split(/,|，/).map(cleanLine).filter(Boolean);
    const members = [];
    for (const nm of membersRaw){
      const ids2 = resolveToIds(nm, nameMap);
      if (!ids2) continue;
      members.push(...ids2);
    }
    const uniqMembers = uniq(members);
    if (uniqMembers.length>=2){
      sibGroups.push({name:gname, members:uniqMembers});
      for (const sid of uniqMembers){
        const st = students.find(s=>s.id===sid);
        if (st) st.sibGroup = gname;
      }
    }
  }

  const traitNames = splitLines($("traitNames").value.replace(/,/g,"\n"));
  return {k, seed, priority, sibRule, students, traitNames, sibGroups};
}

/* ========= Scoring / penalty ========= */
function evaluate(classes, opts){
  const {traitNames, priority} = opts;

  const sizes = classes.map(c=>c.length);
  const sizeAvg = sizes.reduce((a,b)=>a+b,0)/classes.length;
  const sizeVar = sizes.reduce((a,b)=>a+(b-sizeAvg)**2,0)/classes.length;

  // score balance
  const sums = classes.map(c=>c.reduce((a,s)=>a+(s.score??0),0));
  const mean = sums.reduce((a,b)=>a+b,0)/sums.length;
  const scoreVar = sums.reduce((a,b)=>a+(b-mean)**2,0)/sums.length;

  // gender balance
  const g = classes.map(c=>{
    let m=0,f=0,u=0;
    for (const s of c){
      if (s.gender==="남") m++;
      else if (s.gender==="여") f++;
      else u++;
    }
    return {m,f,u};
  });
  const mArr = g.map(x=>x.m), fArr=g.map(x=>x.f);
  const mMean = mArr.reduce((a,b)=>a+b,0)/mArr.length;
  const fMean = fArr.reduce((a,b)=>a+b,0)/fArr.length;
  const genderVar = (mArr.reduce((a,b)=>a+(b-mMean)**2,0)/mArr.length) +
                    (fArr.reduce((a,b)=>a+(b-fMean)**2,0)/fArr.length);

  // trait balance
  let traitVar = 0;
  for (const t of traitNames){
    const cnt = classes.map(c=>c.reduce((a,s)=>a+(s.traits.has(t)?1:0),0));
    const mu = cnt.reduce((a,b)=>a+b,0)/cnt.length;
    traitVar += cnt.reduce((a,b)=>a+(b-mu)**2,0)/cnt.length;
  }

  // weights
  const w = {
    size: 1.0,
    score: priority==="score" ? 5.0 : 2.5,
    gender: priority==="gender" ? 5.0 : 2.0,
    trait: priority==="trait" ? 5.0 : 2.5
  };

  return w.size*sizeVar + w.score*scoreVar + w.gender*genderVar + w.trait*traitVar;
}

/* ========= Constraints ========= */
function canPlace(student, cls){
  // avoid pairs hard constraint
  for (const s of cls){
    if (student.avoid.has(s.id) || s.avoid.has(student.id)) return false;
  }
  return true;
}

/* ========= Assignment algorithm ========= */
function generateAssignment(input){
  const {k, seed, students, sibGroups, sibRule} = input;
  const rand = rng(seed);

  // build groups: sibling groups as "super students"
  const byId = new Map(students.map(s=>[s.id,s]));
  const groupUnits = [];
  const used = new Set();

  for (const g of sibGroups){
    const members = g.members.map(id=>byId.get(id)).filter(Boolean);
    if (members.length>=2){
      groupUnits.push({type:"sib", name:g.name, members});
      members.forEach(m=>used.add(m.id));
    }
  }
  for (const s of students){
    if (!used.has(s.id)) groupUnits.push({type:"single", members:[s]});
  }

  // order: higher score first, else random
  const scoreOfUnit = (u)=>u.members.reduce((a,s)=>a+(s.score??0),0);
  groupUnits.sort((a,b)=>{
    const sa=scoreOfUnit(a), sb=scoreOfUnit(b);
    if (sa!==sb) return sb-sa;
    return rand()-0.5;
  });

  // init classes
  const classes = Array.from({length:k}, ()=>[]);

  function classPenaltyIndex(){
    // choose class with least size then least sum score (greedy)
    const sums = classes.map(c=>c.reduce((a,s)=>a+(s.score??0),0));
    const sizes = classes.map(c=>c.length);
    let best = 0;
    for (let i=1;i<k;i++){
      if (sizes[i] < sizes[best]) best = i;
      else if (sizes[i]===sizes[best] && sums[i] < sums[best]) best = i;
    }
    return best;
  }

  // place units
  for (const unit of groupUnits){
    if (unit.type==="sib" && sibRule==="diff"){
      // place each member into different classes (best effort)
      const members = [...unit.members].sort((a,b)=>(b.score??0)-(a.score??0));
      for (const mem of members){
        let chosen = -1;
        let bestScore = Infinity;
        for (let i=0;i<k;i++){
          const hasSameGroup = classes[i].some(s=>s.sibGroup && s.sibGroup===unit.name);
          if (hasSameGroup) continue;
          if (!canPlace(mem, classes[i])) continue;
          const proxy = classes[i].length * 2 + classes[i].reduce((a,s)=>a+(s.score??0),0);
          if (proxy < bestScore){ bestScore = proxy; chosen = i; }
        }
        if (chosen<0){
          // fallback: ignore sibling diff if impossible
          chosen = classPenaltyIndex();
        }
        classes[chosen].push(mem);
      }
      continue;
    }

    if (unit.type==="sib" && sibRule==="same"){
      // place all together to a class that can accept all avoid constraints
      let chosen = -1;
      let bestScore = Infinity;
      for (let i=0;i<k;i++){
        let ok = true;
        for (const mem of unit.members){
          if (!canPlace(mem, classes[i])) { ok=false; break; }
        }
        if (!ok) continue;
        const proxy = classes[i].length*2 + classes[i].reduce((a,s)=>a+(s.score??0),0);
        if (proxy < bestScore){ bestScore=proxy; chosen=i; }
      }
      if (chosen<0) chosen = classPenaltyIndex(); // fallback
      unit.members.forEach(mem=>classes[chosen].push(mem));
      continue;
    }

    // ignore rule or single: place members one by one
    for (const mem of unit.members){
      let chosen=-1, best=Infinity;
      for (let i=0;i<k;i++){
        if (!canPlace(mem, classes[i])) continue;
        const proxy = classes[i].length*2 + classes[i].reduce((a,s)=>a+(s.score??0),0);
        if (proxy < best){ best=proxy; chosen=i; }
      }
      if (chosen<0) chosen = classPenaltyIndex();
      classes[chosen].push(mem);
    }
  }

  // local improvement: swap to reduce penalty (best-of random tries)
  function attemptImprove(iter=2000){
    let best = evaluate(classes, input);
    for (let t=0;t<iter;t++){
      const a = Math.floor(rand()*k);
      const b = Math.floor(rand()*k);
      if (a===b || classes[a].length===0 || classes[b].length===0) continue;
      const ia = Math.floor(rand()*classes[a].length);
      const ib = Math.floor(rand()*classes[b].length);
      const sa = classes[a][ia], sb = classes[b][ib];

      const newA = classes[a].slice(); newA[ia]=sb;
      const newB = classes[b].slice(); newB[ib]=sa;

      if (!canPlace(sb, newA.filter((_,i)=>i!==ia))) continue;
      if (!canPlace(sa, newB.filter((_,i)=>i!==ib))) continue;

      if (input.sibRule==="diff"){
        const hasDupGroup = (cls)=>{
          const seen=new Set();
          for (const s of cls){
            if (!s.sibGroup) continue;
            if (seen.has(s.sibGroup)) return true;
            seen.add(s.sibGroup);
          }
          return false;
        }
        if (hasDupGroup(newA) || hasDupGroup(newB)) continue;
      }

      const oldA = classes[a], oldB = classes[b];
      classes[a]=newA; classes[b]=newB;
      const now = evaluate(classes, input);
      if (now <= best){
        best = now;
      }else{
        classes[a]=oldA; classes[b]=oldB;
      }
    }
  }
  attemptImprove(2500);

  // sort each class by score desc then name
  for (const cls of classes){
    cls.sort((x,y)=>{
      const sx=x.score??-Infinity, sy=y.score??-Infinity;
      if (sx!==sy) return sy-sx;
      return x.display.localeCompare(y.display, "ko");
    });
  }

  return classes;
}

/* ========= Rendering ========= */
function render(classes, input){
  const tabs = $("tabs");
  const tables = $("tables");
  tabs.innerHTML = "";
  tables.innerHTML = "";

  // summary tab + each class tab (simple filter)
  const tabBtns = [];
  function addTab(label, onClick, active=false){
    const b = document.createElement("button");
    b.className = "tab" + (active?" active":"");
    b.type = "button";
    b.textContent = label;
    b.onclick = ()=>{
      tabBtns.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      onClick();
    };
    tabs.appendChild(b);
    tabBtns.push(b);
  }

  const traitNames = input.traitNames;
  const buildClassCard = (idx)=>{
    const cls = classes[idx];
    const sum = cls.reduce((a,s)=>a+(s.score??0),0);
    const m = cls.filter(s=>s.gender==="남").length;
    const f = cls.filter(s=>s.gender==="여").length;
    const u = cls.filter(s=>!s.gender).length;

    const traitCounts = traitNames.map(t=>[t, cls.filter(s=>s.traits.has(t)).length]).filter(x=>x[1]>0);
    const traitText = traitCounts.length
      ? traitCounts.map(([t,c])=>`${t} ${c}`).join(" · ")
      : "특성 표기 없음";

    const wrap = document.createElement("div");
    wrap.className = "classCard";
    wrap.innerHTML = `
      <div class="classTitle">
        <div>${idx+1}반 <small>(인원 ${cls.length} · 남 ${m} / 여 ${f}${u?(" / 미상 "+u):""} · 점수합 ${sum.toFixed(1)})</small></div>
        <small>${traitText}</small>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:72px;">번호</th>
              <th>이름</th>
              <th style="width:72px;">성별</th>
              <th style="width:90px;">점수</th>
              <th>특성</th>
              <th style="width:120px;">형제그룹</th>
            </tr>
          </thead>
          <tbody>
            ${cls.map((s,i)=>{
              const tr = traitNames.filter(t=>s.traits.has(t)).join(", ");
              return `
                <tr>
                  <td>${i+1}</td>
                  <td>${escapeHtml(s.display)}</td>
                  <td>${s.gender||""}</td>
                  <td>${s.score ?? ""}</td>
                  <td>${escapeHtml(tr)}</td>
                  <td>${escapeHtml(s.sibGroup||"")}</td>
                </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
    return wrap;
  }

  function showAll(){
    tables.innerHTML = "";
    const container = document.createElement("div");
    container.className = "tables";
    for (let i=0;i<classes.length;i++){
      container.appendChild(buildClassCard(i));
    }
    tables.appendChild(container);
  }
  function showOne(i){
    tables.innerHTML = "";
    tables.appendChild(buildClassCard(i));
  }

  addTab("전체", showAll, true);
  for (let i=0;i<classes.length;i++){
    addTab(`${i+1}반`, ()=>showOne(i), false);
  }
  showAll();
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= Copy / CSV ========= */
let last = null;

$("btnCopy").onclick = ()=>{
  if (!last) return;
  const {classes, input} = last;
  let out = [];
  out.push(`반편성 생성기 결과`);
  out.push(`K=${input.k}, seed=${input.seed}, 우선순위=${input.priority}, 형제규칙=${input.sibRule}`);
  out.push("");
  classes.forEach((cls, idx)=>{
    out.push(`${idx+1}반`);
    cls.forEach((s,i)=>{
      const traits = input.traitNames.filter(t=>s.traits.has(t)).join(",");
      out.push(`${i+1}\t${s.display}\t${s.gender||""}\t${s.score??""}\t${traits}\t${s.sibGroup||""}`);
    });
    out.push("");
  });
  navigator.clipboard.writeText(out.join("\n")).catch(()=>{});
};

$("btnCSV").onclick = ()=>{
  if (!last) return;
  const {classes, input} = last;
  const rows = [["반","번호","이름","성별","점수","특성","형제그룹"]];
  classes.forEach((cls, idx)=>{
    cls.forEach((s,i)=>{
      const traits = input.traitNames.filter(t=>s.traits.has(t)).join("|");
      rows.push([`${idx+1}`, `${i+1}`, s.display, s.gender||"", s.score??"", traits, s.sibGroup||""]);
    });
  });
  const csv = rows.map(r=>r.map(v=>{
    const x = String(v??"");
    if (/[",\n]/.test(x)) return `"${x.replaceAll('"','""')}"`;
    return x;
  }).join(",")).join("\n");
  downloadText("반편성_결과.csv", csv);
};

/* ========= Generate ========= */
function setMsg(text, ok=false){
  const el = $("msg");
  if (!text){
    el.style.display="none";
    el.textContent="";
    el.classList.remove("ok");
    return;
  }
  el.style.display="block";
  el.textContent=text;
  el.classList.toggle("ok", !!ok);
}

$("btnGenerate").onclick = ()=>{
  try{
    setMsg("");
    const input = readInputs();

    // sanity: if gender unknown everywhere and user chose gender priority, warn
    const knownG = input.students.filter(s=>s.gender==="남"||s.gender==="여").length;
    if (knownG===0 && input.priority==="gender"){
      setMsg("남/여 정보가 거의 없습니다. '남학생/여학생 목록'을 넣거나 명렬표에 (남)/(여)를 붙이면 남녀 균등이 더 정확해져요.", false);
    }else{
      setMsg("생성 완료! 탭에서 반별 결과를 확인하세요.", true);
    }

    // generate multiple restarts and keep best
    const tries = 6;
    let bestClasses=null, bestScore=Infinity;

    for (let t=0;t<tries;t++){
      const seed2 = input.seed + "-" + (t+1);
      const c = generateAssignment({...input, seed: seed2});
      const sc = evaluate(c, {...input, seed: seed2});
      if (sc < bestScore){
        bestScore = sc;
        bestClasses = c;
      }
    }

    const classes = bestClasses;
    last = {classes, input};
    render(classes, input);

    const el = $("result");
    if (el && el.scrollIntoView) el.scrollIntoView({behavior:"smooth", block:"start"});
  }catch(e){
    setMsg(e.message || String(e), false);
  }
};

$("btnReset").onclick = ()=>{
  ["roster","boys","girls","scores","avoidPairs","siblings"].forEach(id=>$(id).value="");
  $("inputType").value = "single";
  $("existingCount").value = "3";
  $("byClassArea").innerHTML = "";
  syncInputTypeUI();
  $("traitNames").value="ADHD,기초학력,특수교육대상,상자,교우관계,사춘기";
  buildTraitsArea();
  setMsg("");
  last=null;
  $("tabs").innerHTML="";
  $("tables").innerHTML="";
};

$("btnExample").onclick = ()=>{
  $("inputType").value = "single";
  syncInputTypeUI();
  $("k").value = 4;
  $("seed").value = "2026-1";
  $("roster").value = `김하나(여)
홍길동(남)
박민수(남)
이영희(여)
최서준(남)
정지우(여)
김하나
김하나
오민재(남)
유서연(여)
장도윤(남)
서하린(여)
윤지호(남)
배하은(여)
한시우(남)
조아라(여)`;

  $("scores").value = `김하나 92
홍길동 88
박민수 75
이영희 91
최서준 83
정지우 77
오민재 86
유서연 80
장도윤 73
서하린 89
윤지호 78
배하은 85
한시우 72
조아라 84`;

  $("avoidPairs").value = `홍길동 - 박민수
김하나 - 이영희`;

  $("siblings").value = `A가족: 김하나, 김하나a
쌍둥이1: 유서연, 서하린`;

  $("traitNames").value = "ADHD,기초학력,특수교육대상,교우관계";
  buildTraitsArea();
  const tas = Array.from(document.querySelectorAll("#traitsArea textarea"));
  tas.find(x=>x.dataset.trait==="ADHD").value = `박민수
오민재`;
  tas.find(x=>x.dataset.trait==="기초학력").value = `장도윤
한시우`;
  tas.find(x=>x.dataset.trait==="특수교육대상").value = `윤지호`;
  tas.find(x=>x.dataset.trait==="교우관계").value = `홍길동
조아라`;

  setMsg("예시를 채웠습니다. '반편성 생성'을 눌러 확인해보세요.", true);
};
</script>
</body>
</html>
