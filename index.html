<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>반편성 생성기 | Edu Tools</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: "Paperlogy";
      src: url("https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy-5Medium.woff2") format("woff2");
      font-weight: 500;
      font-style: normal;
    }
    @font-face {
      font-family: "Paperlogy";
      src: url("https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy-7Bold.woff2") format("woff2");
      font-weight: 700;
      font-style: normal;
    }

	    :root{
	      --bg:#ffffff;
	      --card:#ffffff;
	      --ink:#111827;
	      --muted:#6b7280;
	      --line:#e5e7eb;
	      --soft:#f3f4f6;

	      --mint:#e9f6e4;
	      --shadow: 0 8px 22px rgba(17, 24, 39, 0.08);
	      --radius: 10px;

	      /* responsive sizing */
	      --fs: clamp(14px, 3.7vw, 16px);
	      --pad-wrap-x: clamp(14px, 4vw, 18px);
	      --pad-card: clamp(12px, 3.6vw, 16px);
	      --ctl-h: clamp(38px, 10vw, 44px);
	      --ctl-pad-y: clamp(8px, 2.3vw, 12px);
	      --ctl-pad-x: clamp(10px, 2.6vw, 14px);
	    }

    *{box-sizing:border-box}
    input, textarea, select, button{
      font: inherit;
      font-size: 16px; /* iOS input auto-zoom prevention */
    }
	    body{
	      margin:0;
	      font-family: "Paperlogy", "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
	      background: var(--bg);
	      color:var(--ink);
	      word-break: keep-all;
	      overflow-wrap: break-word;
	      font-size: var(--fs);
	    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:0;}

    /* money-report-like header */
    .top{
      padding: 16px 0 4px;
      background:
        radial-gradient(900px 280px at 10% 0%, rgba(233, 246, 228, 0.85), rgba(255, 255, 255, 0) 60%),
        radial-gradient(740px 260px at 90% 0%, rgba(37, 99, 235, 0.10), rgba(255, 255, 255, 0) 60%);
    }
	    .top-inner{
	      max-width: 1180px;
	      margin: 0 auto;
	      padding-left: max(var(--pad-wrap-x), env(safe-area-inset-left));
	      padding-right: max(var(--pad-wrap-x), env(safe-area-inset-right));
	      display:flex;
	      align-items:center;
	      gap:14px;
	      min-width:0;
	    }
    .nav-toggle{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      width:42px;
      height:42px;
      cursor:pointer;
      display:grid;
      align-content:center;
      justify-items:center;
      gap:5px;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .nav-toggle:hover{
      box-shadow: 0 12px 26px rgba(17, 24, 39, 0.12);
      transform: translateY(-1px);
      transition: transform 140ms ease, box-shadow 140ms ease;
    }
    .nav-toggle .bar{
      width:18px;
      height:2px;
      background:#111827;
      border-radius:99px;
    }
    .hero{
      display:grid;
      gap:4px;
      min-width:0;
    }
    .hero-top{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
	    .title{
	      margin:0;
	      font-size: clamp(20px, 5.2vw, 26px);
	      letter-spacing:-0.4px;
	      font-weight:900;
	    }
	    .subtitle{
	      margin-top:2px;
	      color:var(--muted);
	      font-size: clamp(12px, 3.2vw, 13px);
	    }

	    .page{
	      width:100%;
	      max-width:1180px;
	      margin-inline:auto;
	      padding-left:max(var(--pad-wrap-x), env(safe-area-inset-left));
	      padding-right:max(var(--pad-wrap-x), env(safe-area-inset-right));
	      padding-top:12px;
	      padding-bottom:48px;
	      min-height:100vh;
	    }

    /* money-report-like sidebar (hamburger category) */
    .sidebar{
      position: fixed;
      top:0;
      left:0;
      height:100%;
      width:320px;
      max-width: calc(100% - 60px);
      background:
        radial-gradient(420px 280px at 20% 0%, rgba(233, 246, 228, 0.85), rgba(255, 255, 255, 0) 60%),
        linear-gradient(180deg, #ffffff, #fbfbfb);
      border-right: 1px solid rgba(229, 231, 235, 0.9);
      box-shadow: 0 22px 54px rgba(0,0,0,.16);
      transform: translateX(-110%);
      transition: transform 200ms ease;
      z-index: 80;
      display:flex;
      flex-direction:column;
      padding-left: env(safe-area-inset-left);
    }
    .scrim{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.28);
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 70;
    }
    body.navOpen{overflow:hidden;}
    body.navOpen .sidebar{transform: translateX(0);}
    body.navOpen .scrim{opacity:1; pointer-events:auto;}
    .side-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px;
      border-bottom: 1px solid rgba(229, 231, 235, 0.9);
    }
    .side-brand{display:flex; align-items:center; gap:10px;}
    .side-mark{
      width:34px; height:34px; border-radius: 12px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.65) 0%, transparent 60%),
        linear-gradient(135deg, rgba(34,197,94,.28), rgba(37,99,235,.18));
      border:1px solid rgba(17,24,39,.08);
    }
    .side-app{font-weight:900;}
    .side-sub{color:var(--muted); font-size:12px; margin-top:2px;}
    .icon-btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      width:40px;
      height:40px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
      font-size:18px;
      line-height:1;
    }
    .side-nav{
      padding: 12px 14px 18px;
      overflow:auto;
    }
    .side-section{
      margin: 14px 0 10px;
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
    }
    .side-link{
      display:grid;
      grid-template-columns: 36px 1fr 18px;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow);
    }
    .side-link + .side-link{margin-top:10px;}
    .side-link:hover{
      transform: translateY(-1px);
      transition: transform 140ms ease;
    }
    .side-link.is-active{
      background: rgba(233, 246, 228, 0.92);
      border-color: rgba(207, 231, 195, 0.9);
    }
    .side-ico{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(243,244,246,.85);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      color: rgba(17,24,39,.75);
      flex:0 0 auto;
    }
    .side-label{font-weight:900; text-align:left;}
    .side-ext{color: var(--muted); font-weight:900; text-align:right;}
    .side-divider{height:1px; background: var(--line); margin:14px 0;}
    .side-note{color: var(--muted); font-size:12px; line-height:1.5;}

    .intro{
      background:rgba(255,255,255,.8);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin: 14px 0;
    }
    .intro p{margin:0; color:var(--muted); line-height:1.6}
	    .grid{
	      display:grid;
	      grid-template-columns: 1.35fr .85fr; /* make inputs wider on desktop */
	      gap:14px;
	      align-items:start;
	    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
	    .card{
	      background:rgba(255,255,255,.9);
	      border:1px solid var(--line);
	      border-radius: var(--radius);
	      box-shadow: var(--shadow);
	      padding: var(--pad-card);
	      min-width: 0;
	    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .sub{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    details.help{
      border:1px solid var(--line);
      background: rgba(255,255,255,.65);
      border-radius: 16px;
      padding:10px 12px;
    }
    details.help summary{
      cursor:pointer;
      font-weight:900;
      color: var(--ink);
      list-style:none;
    }
    details.help summary::-webkit-details-marker{display:none;}
    details.help .hint{margin-top:8px;}
    .helpSteps{
      margin:10px 0 0;
      padding:0;
      display:grid;
      gap:6px;
      color: var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;             /* 라벨-입력 간격 */
      margin-bottom:12px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }
	    input[type="text"], input[type="number"], textarea, select{
	      width:100%;
	      padding: var(--ctl-pad-y) var(--ctl-pad-x);
	      min-height: var(--ctl-h);
	      line-height:1.3;
	      border-radius: 14px;
	      border:1px solid var(--line);
	      background:#fff;
	      outline:none;
	    }
    select{padding-right:44px;}
    textarea{min-height:120px; resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37,99,235,.14);
    }

    .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
    button{
      border:none; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--line);
      color:var(--ink);
      font-weight:600;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(220,252,231,.95), rgba(220,252,231,.65));
      border-color: rgba(34,197,94,.38);
    }
    button.ghost{background:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}

    .toggleRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(255,255,255,.6);
    }
    .toggleRow small{color:var(--muted)}
    .seg{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .seg input{display:none}
    .seg label{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .seg input:checked + label{
      color:var(--ink);
      border-color: rgba(167,139,250,.6);
      background: rgba(233,213,255,.6);
    }

    .resultHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .tabs{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-size:12px; cursor:pointer;
    }
    .tab.active{
      background: rgba(219,234,254,.7);
      border-color: rgba(59,130,246,.25);
      color:var(--ink);
    }

    .tables{display:grid; gap:12px}
    .classCard{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
    }
    .classTitle{
      padding:10px 12px;
      background: rgba(233,213,255,.45);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:800;
    }
    .classTitle small{font-weight:600; color:var(--muted)}
	    table{
	      width:100%;
	      border-collapse:collapse;
	      font-size: clamp(12px, 3.1vw, 13px);
	    }
	    th, td{
	      padding: clamp(8px, 2.4vw, 10px) clamp(8px, 2.4vw, 10px);
	      border-bottom:1px solid var(--line);
	      vertical-align:top;
	    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      background: rgba(241,245,249,.55);
    }
    tr:last-child td{border-bottom:none}

    /* Compact sheet + multi-select dropdown (trait picker) */
    .sheetWrap{border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff}
    .sheetHead{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:10px 12px; background:rgba(241,245,249,.6); border-bottom:1px solid var(--line);
    }
    .sheetHead .hint{margin:0}
	    table.sheet{
	      width:100%;
	      border-collapse:collapse;
	      font-size: clamp(12px, 3.1vw, 13px);
	    }
	    table.sheet th, table.sheet td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:middle}
    table.sheet th{background:rgba(241,245,249,.55); color:var(--muted); font-weight:700}
	    table.sheet td input:not([type="checkbox"]), table.sheet td select{
	      width:100%;
	      min-height:40px;
	      padding:8px 10px;
	      border-radius:12px;
	      border:1px solid var(--line);
	      outline:none;
	      font-size:13px;
	    }
	    @media (max-width: 420px){
	      table.sheet th, table.sheet td{padding:8px 8px;}
	      table.sheet td input:not([type="checkbox"]), table.sheet td select{
	        min-height: 38px;
	        padding: 7px 8px;
	      }
	    }
    table.sheet td select{
      font-weight:800;
      padding-right:40px;
    }
    table.sheet td select.genderSel{
      min-width:96px; /* mobile: make gender visible */
    }
    table.sheet td select.genderSel.is-m{
      background: linear-gradient(180deg, rgba(219,234,254,.9), rgba(219,234,254,.55));
      border-color: rgba(59,130,246,.25);
    }
    table.sheet td select.genderSel.is-f{
      background: linear-gradient(180deg, rgba(254,226,226,.9), rgba(254,226,226,.55));
      border-color: rgba(239,68,68,.20);
    }
    table.sheet td select.genderSel option{font-weight:700;}
    table.sheet td input:not([type="checkbox"]):focus, table.sheet td select:focus{
      border-color: #a78bfa;
      box-shadow: 0 0 0 4px rgba(167,139,250,.14);
    }
    .smallBtn{padding:8px 10px; font-size:12px}
    .badgeBox{display:flex; gap:6px; flex-wrap:wrap}
    .badge{font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(233,213,255,.35)}
    .pop{position:relative}
    .popBtn{
      width:100%;
      text-align:left;
      font-weight:800;
      border-radius:12px;
      min-height:40px;
      padding:8px 10px;
    }
    .popPanel{
      position:absolute; z-index:50; top:44px; left:0;
      width: min(320px, calc(100vw - 48px));
      border:1px solid var(--line); border-radius:14px; background:#fff;
      box-shadow: var(--shadow); padding:10px;
      max-height: min(240px, 42vh);
      overflow:auto;
      display:none;
    }
    .pop.open .popPanel{display:block}
    .popItem{
      display:grid;
      grid-template-columns: 22px 1fr;
      align-items:center;
      gap:10px;
      padding:8px 6px;
      border-radius:10px;
    }
    .popItem:hover{background: rgba(241,245,249,.7);}
    .popItem input[type="checkbox"]{
      width:18px;
      height:18px;
      min-height:auto;
      padding:0;
      margin:0;
      accent-color: #7c3aed;
    }

    .footer{
      margin-top:26px;
      padding:18px 0 26px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(254,242,242,.8);
      color:#991b1b;
      font-size:12px;
      line-height:1.55;
      display:none;
    }
    .ok{
      border-color: rgba(34,197,94,.25);
      background: rgba(240,253,244,.85);
      color:#166534;
    }
  </style>
</head>

<body>
  <aside id="sidebar" class="sidebar" aria-label="카테고리">
    <div class="side-head">
      <div class="side-brand" aria-label="서비스">
        <div class="side-mark" aria-hidden="true"></div>
        <div class="side-brand-text">
          <div class="side-app">Edu Tools</div>
          <div class="side-sub">업무 자동화 도우미</div>
        </div>
      </div>
      <button id="navClose" class="icon-btn" type="button" aria-label="닫기">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <nav class="side-nav" aria-label="카테고리 목록">
      <div class="side-section">생성기</div>
      <a class="side-link is-active" href="/" aria-current="page">
        <span class="side-ico" aria-hidden="true">C</span>
        <span class="side-label">반편성 생성기</span>
        <span class="side-ext" aria-hidden="true"></span>
      </a>
      <a class="side-link" href="https://school-letter.pages.dev/" target="_blank" rel="noreferrer">
        <span class="side-ico" aria-hidden="true">H</span>
        <span class="side-label">가정통신문</span>
        <span class="side-ext" aria-hidden="true">↗</span>
      </a>
      <a class="side-link" href="https://money-report.pages.dev/" target="_blank" rel="noreferrer">
        <span class="side-ico" aria-hidden="true">P</span>
        <span class="side-label">품의생성기</span>
        <span class="side-ext" aria-hidden="true">↗</span>
      </a>
      <a class="side-link" href="https://educate1.pages.dev/" target="_blank" rel="noreferrer">
        <span class="side-ico" aria-hidden="true">D</span>
        <span class="side-label">공문생성기</span>
        <span class="side-ext" aria-hidden="true">↗</span>
      </a>
      <div class="side-divider" role="separator" aria-hidden="true"></div>
      <div class="side-section">연동</div>
      <div class="side-note">추후 이 메뉴에서 서비스 간 연동을 추가합니다.</div>
    </nav>
  </aside>
  <div id="scrim" class="scrim" aria-hidden="true"></div>

  <header class="top">
    <div class="top-inner">
      <button id="navToggle" class="nav-toggle" type="button" aria-label="카테고리 열기" aria-expanded="false">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </button>
      <div class="hero">
        <div class="hero-top">
          <h1 class="title">반편성 생성기</h1>
        </div>
        <div class="subtitle">학생 명렬표로 반편성을 자동으로 생성합니다.</div>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="intro">
      <p>
        학생 명렬표를 <b>그대로 붙여넣기</b> 하면, 점수/남녀/특성/금지조합/쌍둥이 규칙을 반영해
        <b>자동으로 반편성</b>을 생성합니다. (개인정보는 최소화해서 사용하세요.)
      </p>
      <div style="margin-top:12px;">
        <details class="help">
          <summary>사용 안내</summary>
          <div class="hint">
            <div class="helpSteps">
              <div>1. <b>몇 반 생성할지</b>를 설정합니다.</div>
              <div>2. 명렬표를 붙여넣고, <b>표 생성/새로고침</b>을 눌러 학생 표를 만듭니다.</div>
              <div>3. 학생 표에서 <b>성별/점수/특성</b>을 입력한 뒤 <b>반편성 생성</b>을 누릅니다.</div>
              <div>4. 민감한 정보(금지 조합 등)는 최소한으로만 입력하세요.</div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <h2>입력</h2>
        <p class="sub">엑셀에서 이름 열만 복사해서 붙여넣으면 됩니다. (줄바꿈 기준 인식)</p>

        <div class="row">
          <div class="field">
            <label>신입생/재학생 선택</label>
            <select id="mode">
              <option value="new">신입생/신규 편성</option>
              <option value="transfer">재학생(전학/전입 포함)</option>
            </select>
          </div>
          <div class="field">
            <label>재학생인 경우 몇학년</label>
            <select id="grade">
              <option value="">선택 안 함</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>입력 방식</label>
            <select id="inputType">
              <option value="byClass">기존 반별로 입력(1반/2반/3반…)</option>
              <option value="single">전체 명렬표 1개로 입력</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field" id="existingCountWrap" style="display:none;">
            <label>기존 몇 개 반의 자료를 넣을까요</label>
            <input id="existingCount" type="number" min="1" max="20" value="3" />
          </div>
          <div class="field">
            <label>몇 반 생성할지</label>
            <input id="k" type="number" min="2" max="20" value="4" />
          </div>
        </div>

        <div id="byClassArea" style="display:none; margin-top:6px;"></div>

        <div class="field" id="rosterWrap">
          <label>학생 명렬표 (줄바꿈으로 구분)</label>
          <textarea id="roster" placeholder="예:
홍길동
김하나
박민수
이영희"></textarea>
          <div class="hint">팁) 동명이인이 있으면 자동으로 <span class="mono">a/b/c</span>를 붙여 구분합니다.</div>
        </div>

        <div class="row">
          <div class="field">
            <label>남학생 목록 (선택, 줄바꿈)</label>
            <textarea id="boys" placeholder="예:
박민수
홍길동"></textarea>
          </div>
          <div class="field">
            <label>여학생 목록 (선택, 줄바꿈)</label>
            <textarea id="girls" placeholder="예:
김하나
이영희"></textarea>
          </div>
        </div>

        <div class="field">
          <label>점수/등수 (선택) — “이름 점수” 한 줄씩</label>
          <textarea id="scores" placeholder="예:
홍길동 87
김하나 92
박민수 75"></textarea>
          <div class="hint">점수가 없으면 인원/성별/특성 중심으로만 균등화합니다.</div>
        </div>

        <div class="field">
          <label>특성 종류 (콤마로 나열)</label>
          <input id="traitNames" type="text" value="ADHD,기초학력,특수교육대상,교우관계,사춘기" />
          <div class="hint">아래 학생 표에서 각 학생의 특성을 드롭다운으로 선택합니다.</div>
        </div>

        <div class="field">
          <label>학생 표 (명렬표 옆에서 특성 입력)</label>
          <div class="sheetWrap">
            <div class="sheetHead">
              <div class="hint">명렬표를 입력한 뒤 <b>표 생성/새로고침</b>을 누르고, 학생별로 성별/점수/특성을 지정하세요.</div>
              <div class="btns" style="margin:0;">
                <button type="button" class="smallBtn" id="btnBuildSheet">표 생성/새로고침</button>
                <button type="button" class="smallBtn" id="btnClearSheet">표 비우기</button>
              </div>
            </div>
            <div style="overflow:auto;">
              <table class="sheet">
                <thead>
                  <tr>
                    <th style="width:60px;">번호</th>
                    <th style="min-width:140px;">이름</th>
                    <th style="width:90px;">성별</th>
                    <th style="width:90px;">점수</th>
                    <th style="min-width:240px;">특성(멀티선택)</th>
                    <th style="min-width:140px;">쌍둥이그룹</th>
                  </tr>
                </thead>
                <tbody id="sheetBody">
                  <tr><td colspan="6" style="color:var(--muted);">명렬표를 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="field">
          <label>붙으면 안 되는 조합 (한 줄에 1쌍: “이름1 - 이름2”)</label>
          <textarea id="avoidPairs" placeholder="예:
홍길동 - 박민수
김하나 - 이영희"></textarea>
        </div>

        <div class="row">
	          <div class="field">
	            <label>쌍둥이 (선택, 한 줄에 1쌍: “이름1 - 이름2”)</label>
	            <textarea id="siblings" placeholder="예:
홍길동 - 홍길순
김하나 - 김하나a"></textarea>
              <div class="hint" style="margin-top:8px;">아래에서 각 쌍마다 <b>합반(같은 반)</b>/<b>분반(다른 반)</b>을 체크로 지정할 수 있습니다.</div>
	          </div>
            <div class="field">
              <label>쌍둥이 표</label>
              <div class="sheetWrap">
                <div class="sheetHead">
                  <div class="hint">쌍둥이 목록을 입력한 뒤 <b>표 생성/새로고침</b>을 누르고, 각 쌍의 규칙을 체크하세요.</div>
                  <div class="btns" style="margin:0;">
                    <button type="button" class="smallBtn" id="btnBuildTwins">표 생성/새로고침</button>
                    <button type="button" class="smallBtn" id="btnClearTwins">표 비우기</button>
                  </div>
                </div>
                <div style="overflow:auto;">
                  <table class="sheet">
                    <thead>
                      <tr>
                        <th style="width:60px;">번호</th>
                        <th>이름1</th>
                        <th>이름2</th>
                        <th style="width:92px;">합반</th>
                        <th style="width:92px;">분반</th>
                      </tr>
                    </thead>
                    <tbody id="twinBody">
                      <tr><td colspan="5" style="color:var(--muted);">쌍둥이 목록을 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="toggleRow" style="margin-top:10px;">
                <small>우선순위</small>
                <div class="row" style="width:100%; margin-top:6px;">
                  <div class="field" style="margin:0;">
                    <label>1순위</label>
                    <select id="prio1">
                      <option value="gender">남녀균형</option>
                      <option value="score">점수균형</option>
                      <option value="trait">특성균형</option>
                    </select>
                  </div>
                  <div class="field" style="margin:0;">
                    <label>2순위</label>
                    <select id="prio2">
                      <option value="score">점수균형</option>
                      <option value="trait">특성균형</option>
                      <option value="gender">남녀균형</option>
                    </select>
                  </div>
                </div>
                <div class="row" style="width:100%; margin-top:6px;">
                  <div class="field" style="margin:0;">
                    <label>3순위</label>
                    <select id="prio3">
                      <option value="trait">특성균형</option>
                      <option value="score">점수균형</option>
                      <option value="gender">남녀균형</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
	        </div>

        <div class="btns">
          <button class="primary" id="btnGenerate">반편성 생성</button>
          <button class="ghost" id="btnExample">예시 입력</button>
          <button id="btnReset">입력 초기화</button>
        </div>

        <div class="warn" id="msg"></div>
      </div>

      <!-- RIGHT: RESULT -->
      <div class="card" id="result">
        <div class="resultHead">
          <div>
            <h2 style="margin:0 0 4px;">생성 결과</h2>
            <div class="hint">복사/다운로드 후 결과가 마음에 들지 않으면 다시 생성해 다른 조합도 만들어보세요.</div>
          </div>
          <div class="btns" style="margin:0;">
            <button id="btnCopy">결과 복사</button>
            <button id="btnCSV">CSV 다운로드</button>
          </div>
        </div>

        <div class="tabs" id="tabs"></div>
        <div id="tables" class="tables"></div>
      </div>
    </div>

    <div class="footer">
      반편성 생성기<br/>
      Copyright © HONGSEOK LEE. All rights reserved.
    </div>
  </main>

<script>
/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
const cleanLine = (s)=>String(s||"").trim();
const splitLines = (t)=>String(t||"").split(/\r?\n/).map(cleanLine).filter(Boolean);
const uniq = (arr)=>Array.from(new Set(arr));

// Sidebar (hamburger category) toggle
const sidebar = document.getElementById("sidebar");
const scrim = document.getElementById("scrim");
const navToggle = document.getElementById("navToggle");
const navClose = document.getElementById("navClose");

function openNav(){
  document.body.classList.add("navOpen");
  navToggle?.setAttribute("aria-expanded", "true");
  scrim?.setAttribute("aria-hidden", "false");
}
function closeNav(){
  document.body.classList.remove("navOpen");
  navToggle?.setAttribute("aria-expanded", "false");
  scrim?.setAttribute("aria-hidden", "true");
}
function toggleNav(){
  if (document.body.classList.contains("navOpen")) closeNav();
  else openNav();
}
navToggle?.addEventListener("click", toggleNav);
navClose?.addEventListener("click", closeNav);
scrim?.addEventListener("click", closeNav);
document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") closeNav();
});

function buildByClassInputs(){
  const area = $("byClassArea");
  const n = Math.max(1, Math.min(20, parseInt($("existingCount")?.value || "1", 10)));

  area.innerHTML = "";
  for (let i=1;i<=n;i++){
    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
      <label>기존 ${i}반 명렬표 (줄바꿈)</label>
      <textarea data-existing-class="${i}" placeholder="예:\n홍길동\n김하나\n박민수"></textarea>
    `;
    area.appendChild(div);
  }
}

function readExistingClassRosterEntries(){
  const tas = Array.from(document.querySelectorAll('#byClassArea textarea[data-existing-class]'));
  const all = [];
  for (const ta of tas){
    const clsNo = parseInt(ta.dataset.existingClass || "0", 10) || null;
    const lines = splitLines(ta.value);
    for (let i=0;i<lines.length;i++){
      all.push({raw: lines[i], prevClass: clsNo, prevNo: i+1});
    }
  }
  return all;
}

function syncInputTypeUI(){
  const t = $("inputType")?.value || "single";
  const showByClass = (t === "byClass");
  $("existingCountWrap").style.display = showByClass ? "" : "none";
  $("byClassArea").style.display = showByClass ? "" : "none";
  $("rosterWrap").style.display = showByClass ? "none" : "block";
  if (showByClass) buildByClassInputs();
}

$("inputType").addEventListener("change", syncInputTypeUI);
$("existingCount").addEventListener("input", ()=>{
  if (($("inputType")?.value || "single") === "byClass") buildByClassInputs();
});
syncInputTypeUI();

function hashSeed(str){
  // simple deterministic hash -> int
  let h = 2166136261>>>0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h>>>0;
}
function rng(seedStr){
  // mulberry32
  let a = hashSeed(seedStr);
  return function(){
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function parseNameGender(raw){
  // formats: "홍길동(남)" "홍길동,여" "남:홍길동"
  let s = cleanLine(raw);
  let gender = null;

  const m1 = s.match(/^(남|여)\s*[:：]\s*(.+)$/);
  if (m1){ gender = m1[1]; s = cleanLine(m1[2]); return {name:s, gender}; }

  const m2 = s.match(/^(.+?)[,\t ]+(남|여)$/);
  if (m2){ return {name:cleanLine(m2[1]), gender:m2[2]}; }

  const m3 = s.match(/^(.+?)\s*\((남|여)\)\s*$/);
  if (m3){ return {name:cleanLine(m3[1]), gender:m3[2]}; }

  return {name:s, gender:null};
}
function disambiguateNames(names){
  // same name -> namea, nameb, namec...
  const count = {};
  const out = [];
  for (const n of names){
    count[n] = (count[n]||0)+1;
    if (count[n]===1){ out.push(n); }
    else{
      const suffix = String.fromCharCode(95 + count[n]); // 2->a, 3->b ...
      out.push(n + suffix);
    }
  }
  return out;
}
function normalizeNameMap(students){
  // map baseName -> list of unique ids
  const map = new Map();
  for (const st of students){
    const base = st.baseName;
    if (!map.has(base)) map.set(base, []);
    map.get(base).push(st.id);
  }
  return map;
}
function resolveToIds(name, nameMap){
  // if exact id exists, use it; else if base exists and only one, use it; else null
  if (nameMap.__idSet && nameMap.__idSet.has(name)) return [name];
  if (nameMap.has(name) && nameMap.get(name).length===1) return [nameMap.get(name)[0]];
  // try strip trailing a/b/c (동명이인)
  const base = name.replace(/[a-z]$/,'');
  if (nameMap.has(base) && nameMap.get(base).length===1) return [nameMap.get(base)[0]];
  return null;
}
function downloadText(filename, text, mime){
  const blob = new Blob([text], {type: mime || "text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= UI: student sheet (trait dropdown) ========= */
function getTraitList(){
  return splitLines($("traitNames").value.replace(/,/g,"\n"));
}

function makeTraitPicker(selectedSet, traitList){
  const wrap = document.createElement("div");
  wrap.className = "pop";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "smallBtn popBtn";
  btn.textContent = selectedSet.size ? "특성 선택됨" : "특성 선택";

  const panel = document.createElement("div");
  panel.className = "popPanel";

  const badgeBox = document.createElement("div");
  badgeBox.className = "badgeBox";
  badgeBox.style.marginBottom = "8px";
  panel.appendChild(badgeBox);

  function refreshBadges(){
    badgeBox.innerHTML = "";
    for (const t of Array.from(selectedSet)){
      const b = document.createElement("span");
      b.className = "badge";
      b.textContent = t;
      badgeBox.appendChild(b);
    }
    if (!selectedSet.size){
      btn.textContent = "특성 선택";
      return;
    }
    const names = Array.from(selectedSet);
    const head = names.slice(0, 2).join(", ");
    const rest = names.length - 2;
    btn.textContent = rest > 0 ? `${head} 외 ${rest}` : head;
  }

  for (const t of traitList){
    const item = document.createElement("label");
    item.className = "popItem";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = selectedSet.has(t);
    cb.addEventListener("change", ()=>{
      if (cb.checked) selectedSet.add(t);
      else selectedSet.delete(t);
      refreshBadges();
    });
    const span = document.createElement("span");
    span.textContent = t;
    item.appendChild(cb);
    item.appendChild(span);
    panel.appendChild(item);
  }

  btn.addEventListener("click", ()=>{
    wrap.classList.toggle("open");
  });

  // close on outside click
  document.addEventListener("click", (e)=>{
    if (!wrap.contains(e.target)) wrap.classList.remove("open");
  });

  wrap.appendChild(btn);
  wrap.appendChild(panel);
  refreshBadges();
  return {wrap, selectedSet};
}

function sheetSnapshot(){
  const rows = Array.from(document.querySelectorAll("#sheetBody tr[data-student-id]"));
  const snap = new Map();
  for (const r of rows){
    const id = r.dataset.studentId;
    const gender = r.querySelector('select[data-sheet="gender"]')?.value || "";
    const score = r.querySelector('input[data-sheet="score"]')?.value || "";
    const sib = r.querySelector('input[data-sheet="sib"]')?.value || "";
    const traits = Array.from(r.querySelectorAll('input[type="checkbox"][data-sheet-trait]'))
      .filter(cb=>cb.checked)
      .map(cb=>cb.dataset.sheetTrait);
    snap.set(id, {gender, score, sib, traits});
  }
  return snap;
}

function buildSheetFromRoster(){
  const inputType = $("inputType") ? $("inputType").value : "single";
  let rosterLines = [];
  if (inputType === "byClass") rosterLines = readExistingClassRosterEntries().map(e=>e.raw);
  else rosterLines = splitLines($("roster").value);

  const tbody = $("sheetBody");
  if (!rosterLines.length){
    tbody.innerHTML = `<tr><td colspan="6" style="color:var(--muted);">명렬표가 비어있어요.</td></tr>`;
    return;
  }

  const prev = sheetSnapshot();

  // parse + disambiguate
  const parsed = rosterLines.map(parseNameGender);
  const baseNames = parsed.map(x=>x.name);
  const ids = disambiguateNames(baseNames);
  const traitList = getTraitList();

  tbody.innerHTML = "";

  for (let i=0;i<ids.length;i++){
    const id = ids[i];
    const base = parsed[i].name;
    const g0 = parsed[i].gender || "";
    const keep = prev.get(id);

    const tr = document.createElement("tr");
    tr.dataset.studentId = id;

    const tdNo = document.createElement("td");
    tdNo.textContent = String(i+1);
    tr.appendChild(tdNo);

    const tdName = document.createElement("td");
    tdName.textContent = id;
    tdName.dataset.baseName = base;
    tr.appendChild(tdName);

    const tdGender = document.createElement("td");
    const selG = document.createElement("select");
    selG.dataset.sheet = "gender";
    selG.className = "genderSel";
    selG.innerHTML = `
      <option value="">미상</option>
      <option value="남">남</option>
      <option value="여">여</option>
    `;
    selG.value = keep?.gender || g0;
    const paintGender = ()=>{
      selG.classList.toggle("is-m", selG.value === "남");
      selG.classList.toggle("is-f", selG.value === "여");
    };
    selG.addEventListener("change", paintGender);
    paintGender();
    tdGender.appendChild(selG);
    tr.appendChild(tdGender);

    const tdScore = document.createElement("td");
    const inpS = document.createElement("input");
    inpS.type = "number";
    inpS.dataset.sheet = "score";
    inpS.value = keep?.score || "";
    tdScore.appendChild(inpS);
    tr.appendChild(tdScore);

    const tdTraits = document.createElement("td");
    const set = new Set(keep?.traits || []);
    const picker = makeTraitPicker(set, traitList);
    // mark checkboxes so we can read them later
    for (const cb of Array.from(picker.wrap.querySelectorAll('input[type="checkbox"]'))){
      const label = cb.parentElement?.textContent?.trim() || "";
      cb.dataset.sheetTrait = label;
    }
    tdTraits.appendChild(picker.wrap);
    tr.appendChild(tdTraits);

    const tdSib = document.createElement("td");
    const inpG = document.createElement("input");
    inpG.type = "text";
    inpG.dataset.sheet = "sib";
    inpG.value = keep?.sib || "";
    tdSib.appendChild(inpG);
    tr.appendChild(tdSib);

    tbody.appendChild(tr);
  }
}

$("btnBuildSheet").addEventListener("click", buildSheetFromRoster);
$("btnClearSheet").addEventListener("click", ()=>{
  $("sheetBody").innerHTML = `<tr><td colspan="6" style="color:var(--muted);">명렬표를 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>`;
});

// trait list changes should refresh pickers (keep current selections where possible)
$("traitNames").addEventListener("input", ()=>{
  const hasSheet = document.querySelectorAll("#sheetBody tr[data-student-id]").length > 0;
  if (hasSheet) buildSheetFromRoster();
});

/* ========= UI: twins table (per-pair rule) ========= */
function twinsSnapshot(){
  const rows = Array.from(document.querySelectorAll("#twinBody tr[data-twin-a][data-twin-b]"));
  const snap = new Map();
  for (const r of rows){
    const a = cleanLine(r.dataset.twinA || "");
    const b = cleanLine(r.dataset.twinB || "");
    if (!a || !b) continue;
    const key = `${a}||${b}`;
    const same = !!r.querySelector('input[data-twin-rule="same"]')?.checked;
    const diff = !!r.querySelector('input[data-twin-rule="diff"]')?.checked;
    snap.set(key, {same, diff});
  }
  return snap;
}

function buildTwinsTable(){
  const tbody = $("twinBody");
  const lines = splitLines($("siblings").value);
  if (!lines.length){
    tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">쌍둥이 목록을 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>`;
    return;
  }

  const prev = twinsSnapshot();
  const pairs = [];
  for (const line of lines){
    const parts = line.split("-").map(cleanLine);
    if (parts.length < 2) continue;
    const a = parts[0];
    const b = parts[1];
    if (!a || !b) continue;
    pairs.push([a,b]);
  }
  if (!pairs.length){
    tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">형식이 맞지 않습니다. 한 줄에 “이름1 - 이름2” 형태로 입력해 주세요.</td></tr>`;
    return;
  }

  tbody.innerHTML = "";
  pairs.forEach(([a,b], idx)=>{
    const key = `${a}||${b}`;
    const keep = prev.get(key);
    const tr = document.createElement("tr");
    tr.dataset.twinA = a;
    tr.dataset.twinB = b;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${escapeHtml(a)}</td>
      <td>${escapeHtml(b)}</td>
      <td style="text-align:center;"><input type="checkbox" data-twin-rule="same" aria-label="합반"></td>
      <td style="text-align:center;"><input type="checkbox" data-twin-rule="diff" aria-label="분반"></td>
    `;
    const cbSame = tr.querySelector('input[data-twin-rule="same"]');
    const cbDiff = tr.querySelector('input[data-twin-rule="diff"]');
    cbSame.checked = keep ? !!keep.same : true; // default: same class
    cbDiff.checked = keep ? !!keep.diff : false;

    const sync = (src)=>{
      if (src === cbSame && cbSame.checked) cbDiff.checked = false;
      if (src === cbDiff && cbDiff.checked) cbSame.checked = false;
    };
    cbSame.addEventListener("change", ()=>sync(cbSame));
    cbDiff.addEventListener("change", ()=>sync(cbDiff));

    tbody.appendChild(tr);
  });
}

$("btnBuildTwins").addEventListener("click", buildTwinsTable);
$("btnClearTwins").addEventListener("click", ()=>{
  $("twinBody").innerHTML = `<tr><td colspan="5" style="color:var(--muted);">쌍둥이 목록을 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>`;
});

/* ========= Core: parse inputs ========= */
function readInputs(){
  const k = Math.max(2, Math.min(20, parseInt($("k").value||"4",10)));
  // seed: internal only (user input removed)
  const seed = String(Date.now());
  const grade = cleanLine($("grade")?.value || "");
  const priorityOrder = [cleanLine($("prio1")?.value || ""), cleanLine($("prio2")?.value || ""), cleanLine($("prio3")?.value || "")].filter(Boolean);
  const priority = priorityOrder[0] || "gender";

  // roster
  let rosterEntries = [];
  const inputType = $("inputType") ? $("inputType").value : "single";
  if (inputType === "byClass"){
    rosterEntries = readExistingClassRosterEntries();
  } else {
    const lines = splitLines($("roster").value);
    rosterEntries = lines.map((raw, i)=>({raw, prevClass: null, prevNo: i+1}));
  }
  if (rosterEntries.length < k) throw new Error("학생 명렬표가 너무 적습니다. 최소 반 수 이상 입력해 주세요.");

  // parse roster with optional gender
  const parsed = rosterEntries.map(e=>parseNameGender(e.raw));
  const baseNames = parsed.map(x=>x.name);
  const ids = disambiguateNames(baseNames);

  const students = ids.map((id, i)=>({
    id,
    baseName: parsed[i].name,     // before disambiguation
    display: id,                  // show id (with a/b/c if needed)
    gender: parsed[i].gender,     // 남/여/null
    score: null,
    traits: new Set(),
    sibGroup: null,
    prevClass: rosterEntries[i].prevClass,
    prevNo: rosterEntries[i].prevNo,
    avoid: new Set()
  }));

  // build name map
  const nameMap = normalizeNameMap(students);
  nameMap.__idSet = new Set(students.map(s=>s.id));

  // optional boys/girls lists override
  const boys = new Set(splitLines($("boys").value));
  const girls = new Set(splitLines($("girls").value));

  if (boys.size || girls.size){
    for (const st of students){
      const base = st.baseName;
      const id = st.id;
      if (boys.has(base) || boys.has(id)) st.gender = "남";
      if (girls.has(base) || girls.has(id)) st.gender = "여";
    }
  }

  // scores
  const scoreLines = splitLines($("scores").value);
  for (const line of scoreLines){
    const m = line.match(/^(.+?)\s+(-?\d+(?:\.\d+)?)$/);
    if (!m) continue;
    const nm = cleanLine(m[1]);
    const val = parseFloat(m[2]);
    const ids2 = resolveToIds(nm, nameMap);
    if (!ids2) continue;
    for (const sid of ids2){
      const st = students.find(x=>x.id===sid);
      if (st) st.score = val;
    }
  }

  // sheet: gender/score/traits/sibling-group (takes precedence over roster/boys&girls/scores textarea)
  const sheetRows = Array.from(document.querySelectorAll("#sheetBody tr[data-student-id]"));
  if (sheetRows.length){
    for (const r of sheetRows){
      const studentId = r.dataset.studentId;
      const st = students.find(x=>x.id === studentId);
      if (!st) continue;

      const genderSel = r.querySelector('select[data-sheet="gender"]');
      const scoreInp = r.querySelector('input[data-sheet="score"]');
      const sibInp = r.querySelector('input[data-sheet="sib"]');

      const gv = cleanLine(genderSel?.value || "");
      if (gv) st.gender = gv;

      const sv = scoreInp?.value;
      if (!(sv === "" || sv == null)) st.score = parseFloat(sv);

      const gname = cleanLine(sibInp?.value || "");
      st.sibGroup = gname || null;

      const checks = Array.from(r.querySelectorAll('input[type="checkbox"][data-sheet-trait]'));
      st.traits = new Set(checks.filter(c=>c.checked).map(c=>c.dataset.sheetTrait).filter(Boolean));
    }
  }

  // avoid pairs
  const avoidLines = splitLines($("avoidPairs").value);
  for (const line of avoidLines){
    const parts = line.split("-").map(cleanLine);
    if (parts.length<2) continue;
    const a = parts[0], b = parts[1];
    const ida = resolveToIds(a, nameMap);
    const idb = resolveToIds(b, nameMap);
    if (!ida || !idb) continue;
    for (const x of ida){
      for (const y of idb){
        if (x===y) continue;
        students.find(s=>s.id===x)?.avoid.add(y);
        students.find(s=>s.id===y)?.avoid.add(x);
      }
    }
  }

  // Twins rules per pair (from twin table): 합반 -> same-group, 분반 -> avoid (different class)
  // If textarea has content but table isn't built yet, auto-build with defaults.
  const hasTwinTable = document.querySelectorAll("#twinBody tr[data-twin-a][data-twin-b]").length > 0;
  if (!hasTwinTable && splitLines($("siblings").value).length){
    buildTwinsTable();
  }
  const twinRows = Array.from(document.querySelectorAll("#twinBody tr[data-twin-a][data-twin-b]"));
  const parent = new Map();
  function find(x){
    const p = parent.get(x) ?? x;
    if (p === x) return x;
    const r = find(p);
    parent.set(x, r);
    return r;
  }
  function unite(a, b){
    const ra = find(a), rb = find(b);
    if (ra !== rb) parent.set(ra, rb);
  }

  function addDiff(aId, bId){
    if (aId === bId) return;
    students.find(s=>s.id===aId)?.avoid.add(bId);
    students.find(s=>s.id===bId)?.avoid.add(aId);
  }

  for (const r of twinRows){
    const rawA = cleanLine(r.dataset.twinA || "");
    const rawB = cleanLine(r.dataset.twinB || "");
    if (!rawA || !rawB) continue;
    const ida = resolveToIds(rawA, nameMap);
    const idb = resolveToIds(rawB, nameMap);
    if (!ida || !idb) continue;

    const same = !!r.querySelector('input[data-twin-rule="same"]')?.checked;
    const diff = !!r.querySelector('input[data-twin-rule="diff"]')?.checked;
    if (!same && !diff) continue;

    for (const x of ida){
      for (const y of idb){
        if (x === y) continue;
        if (same){
          parent.set(x, parent.get(x) ?? x);
          parent.set(y, parent.get(y) ?? y);
          unite(x, y);
        } else if (diff){
          addDiff(x, y);
        }
      }
    }
  }

  // materialize same-group unions into named groups
  const groups = new Map();
  for (const id of parent.keys()){
    const r = find(id);
    if (!groups.has(r)) groups.set(r, []);
    groups.get(r).push(id);
  }
  let gidx = 1;
  for (const members of groups.values()){
    const uniqMembers = uniq(members);
    if (uniqMembers.length < 2) continue;
    const gname = `쌍둥이${gidx++}`;
    for (const sid of uniqMembers){
      const st = students.find(s=>s.id===sid);
      if (st && !st.sibGroup) st.sibGroup = gname;
    }
  }

  const sibGroups = [];
  const byGroup = new Map();
  for (const st of students){
    const g = cleanLine(st.sibGroup || "");
    if (!g) continue;
    if (!byGroup.has(g)) byGroup.set(g, []);
    byGroup.get(g).push(st.id);
  }
  for (const [gname, members] of byGroup.entries()){
    const uniqMembers = uniq(members);
    if (uniqMembers.length >= 2) sibGroups.push({name:gname, members:uniqMembers});
  }

  const traitNames = splitLines($("traitNames").value.replace(/,/g,"\n"));
  return {k, seed, grade, priority, priorityOrder, students, traitNames, sibGroups};
}

/* ========= Scoring / penalty ========= */
function evaluate(classes, opts){
  const {traitNames, priorityOrder} = opts;

  const sizes = classes.map(c=>c.length);
  const sizeAvg = sizes.reduce((a,b)=>a+b,0)/classes.length;
  const sizeVar = sizes.reduce((a,b)=>a+(b-sizeAvg)**2,0)/classes.length;

  // score balance
  const sums = classes.map(c=>c.reduce((a,s)=>a+(s.score??0),0));
  const mean = sums.reduce((a,b)=>a+b,0)/sums.length;
  const scoreVar = sums.reduce((a,b)=>a+(b-mean)**2,0)/sums.length;

  // gender balance
  const g = classes.map(c=>{
    let m=0,f=0,u=0;
    for (const s of c){
      if (s.gender==="남") m++;
      else if (s.gender==="여") f++;
      else u++;
    }
    return {m,f,u};
  });
  const mArr = g.map(x=>x.m), fArr=g.map(x=>x.f);
  const mMean = mArr.reduce((a,b)=>a+b,0)/mArr.length;
  const fMean = fArr.reduce((a,b)=>a+b,0)/fArr.length;
  const genderVar = (mArr.reduce((a,b)=>a+(b-mMean)**2,0)/mArr.length) +
                    (fArr.reduce((a,b)=>a+(b-fMean)**2,0)/fArr.length);

  // trait balance
  let traitVar = 0;
  for (const t of traitNames){
    const cnt = classes.map(c=>c.reduce((a,s)=>a+(s.traits.has(t)?1:0),0));
    const mu = cnt.reduce((a,b)=>a+b,0)/cnt.length;
    traitVar += cnt.reduce((a,b)=>a+(b-mu)**2,0)/cnt.length;
  }

  function wRank(metric){
    const order = Array.isArray(priorityOrder) ? priorityOrder : [];
    const i = order.indexOf(metric);
    if (i === 0) return 5.0;
    if (i === 1) return 3.2;
    if (i === 2) return 2.0;
    return 2.0;
  }

  const w = {
    size: 1.0,
    score: wRank("score"),
    gender: wRank("gender"),
    trait: wRank("trait"),
  };

  return w.size*sizeVar + w.score*scoreVar + w.gender*genderVar + w.trait*traitVar;
}

/* ========= Constraints ========= */
function canPlace(student, cls){
  // avoid pairs hard constraint
  for (const s of cls){
    if (student.avoid.has(s.id) || s.avoid.has(student.id)) return false;
  }
  return true;
}

/* ========= Assignment algorithm ========= */
function generateAssignment(input){
  const {k, seed, students, sibGroups} = input;
  const rand = rng(seed);

  // build groups: sibling groups as "super students"
  const byId = new Map(students.map(s=>[s.id,s]));
  const groupUnits = [];
  const used = new Set();

  for (const g of sibGroups){
    const members = g.members.map(id=>byId.get(id)).filter(Boolean);
    if (members.length>=2){
      groupUnits.push({type:"sib", name:g.name, members});
      members.forEach(m=>used.add(m.id));
    }
  }
  for (const s of students){
    if (!used.has(s.id)) groupUnits.push({type:"single", members:[s]});
  }

  // order: higher score first, else random
  const scoreOfUnit = (u)=>u.members.reduce((a,s)=>a+(s.score??0),0);
  groupUnits.sort((a,b)=>{
    const sa=scoreOfUnit(a), sb=scoreOfUnit(b);
    if (sa!==sb) return sb-sa;
    return rand()-0.5;
  });

  // init classes
  const classes = Array.from({length:k}, ()=>[]);

  function classPenaltyIndex(){
    // choose class with least size then least sum score (greedy)
    const sums = classes.map(c=>c.reduce((a,s)=>a+(s.score??0),0));
    const sizes = classes.map(c=>c.length);
    let best = 0;
    for (let i=1;i<k;i++){
      if (sizes[i] < sizes[best]) best = i;
      else if (sizes[i]===sizes[best] && sums[i] < sums[best]) best = i;
    }
    return best;
  }

  // place units
  for (const unit of groupUnits){
    if (unit.type==="sib"){
      // Always keep same-group units together (twin same-class constraint).
      let chosen = -1;
      let bestScore = Infinity;
      for (let i=0;i<k;i++){
        let ok = true;
        for (const mem of unit.members){
          if (!canPlace(mem, classes[i])) { ok=false; break; }
        }
        if (!ok) continue;
        const proxy = classes[i].length*2 + classes[i].reduce((a,s)=>a+(s.score??0),0);
        if (proxy < bestScore){ bestScore=proxy; chosen=i; }
      }
      if (chosen<0) chosen = classPenaltyIndex();
      unit.members.forEach(mem=>classes[chosen].push(mem));
      continue;
    }

    // ignore rule or single: place members one by one
    for (const mem of unit.members){
      let chosen=-1, best=Infinity;
      for (let i=0;i<k;i++){
        if (!canPlace(mem, classes[i])) continue;
        const proxy = classes[i].length*2 + classes[i].reduce((a,s)=>a+(s.score??0),0);
        if (proxy < best){ best=proxy; chosen=i; }
      }
      if (chosen<0) chosen = classPenaltyIndex();
      classes[chosen].push(mem);
    }
  }

  // local improvement: swap to reduce penalty (best-of random tries)
  function attemptImprove(iter=2000){
    let best = evaluate(classes, input);
    for (let t=0;t<iter;t++){
      const a = Math.floor(rand()*k);
      const b = Math.floor(rand()*k);
      if (a===b || classes[a].length===0 || classes[b].length===0) continue;
      const ia = Math.floor(rand()*classes[a].length);
      const ib = Math.floor(rand()*classes[b].length);
      const sa = classes[a][ia], sb = classes[b][ib];

      const newA = classes[a].slice(); newA[ia]=sb;
      const newB = classes[b].slice(); newB[ib]=sa;

      if (!canPlace(sb, newA.filter((_,i)=>i!==ia))) continue;
      if (!canPlace(sa, newB.filter((_,i)=>i!==ib))) continue;

      // Twin split constraints are modeled as avoid pairs; no extra handling needed here.

      const oldA = classes[a], oldB = classes[b];
      classes[a]=newA; classes[b]=newB;
      const now = evaluate(classes, input);
      if (now <= best){
        best = now;
      }else{
        classes[a]=oldA; classes[b]=oldB;
      }
    }
  }
  attemptImprove(2500);

  // sort each class by score desc then name
  for (const cls of classes){
    cls.sort((x,y)=>{
      const sx=x.score??-Infinity, sy=y.score??-Infinity;
      if (sx!==sy) return sy-sx;
      return x.display.localeCompare(y.display, "ko");
    });
  }

  return classes;
}

/* ========= Rendering ========= */
function render(classes, input){
  const tabs = $("tabs");
  const tables = $("tables");
  tabs.innerHTML = "";
  tables.innerHTML = "";

  // summary tab + each class tab (simple filter)
  const tabBtns = [];
  function addTab(label, onClick, active=false){
    const b = document.createElement("button");
    b.className = "tab" + (active?" active":"");
    b.type = "button";
    b.textContent = label;
    b.onclick = ()=>{
      tabBtns.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      onClick();
    };
    tabs.appendChild(b);
    tabBtns.push(b);
  }

  const traitNames = input.traitNames;
  const buildClassCard = (idx)=>{
    const cls = classes[idx];
    const sum = cls.reduce((a,s)=>a+(s.score??0),0);
    const m = cls.filter(s=>s.gender==="남").length;
    const f = cls.filter(s=>s.gender==="여").length;
    const u = cls.filter(s=>!s.gender).length;

    const traitCounts = traitNames.map(t=>[t, cls.filter(s=>s.traits.has(t)).length]).filter(x=>x[1]>0);
    const traitText = traitCounts.length
      ? traitCounts.map(([t,c])=>`${t} ${c}`).join(" · ")
      : "특성 표기 없음";

    const wrap = document.createElement("div");
    wrap.className = "classCard";
    wrap.innerHTML = `
      <div class="classTitle">
        <div>${idx+1}반 <small>(인원 ${cls.length} · 남 ${m} / 여 ${f}${u?(" / 미상 "+u):""} · 점수합 ${sum.toFixed(1)})</small></div>
        <small>${traitText}</small>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
	              <th style="width:92px;">학년-반-번호</th>
              <th>이름</th>
              <th style="width:72px;">성별</th>
              <th style="width:90px;">점수</th>
              <th>특성</th>
              <th style="width:120px;">쌍둥이그룹</th>
            </tr>
          </thead>
          <tbody>
            ${cls.map((s,i)=>{
              const tr = traitNames.filter(t=>s.traits.has(t)).join(", ");
              return `
                <tr>
	                  <td>${escapeHtml((input.grade ? input.grade + "-" : "") + (idx+1) + "-" + (i+1))}</td>
                  <td>${escapeHtml(s.display)}</td>
                  <td>${s.gender||""}</td>
                  <td>${s.score ?? ""}</td>
                  <td>${escapeHtml(tr)}</td>
                  <td>${escapeHtml(s.sibGroup||"")}</td>
                </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
    return wrap;
  }

  function showAll(){
    tables.innerHTML = "";
    const container = document.createElement("div");
    container.className = "tables";
    for (let i=0;i<classes.length;i++){
      container.appendChild(buildClassCard(i));
    }
    tables.appendChild(container);
  }
  function showOne(i){
    tables.innerHTML = "";
    tables.appendChild(buildClassCard(i));
  }

  addTab("전체", showAll, true);
  for (let i=0;i<classes.length;i++){
    addTab(`${i+1}반`, ()=>showOne(i), false);
  }
  showAll();
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= Copy / CSV ========= */
let last = null;

$("btnCopy").onclick = ()=>{
  if (!last) return;
  const {classes, input} = last;
  let out = [];
  out.push(`반편성 생성기 결과`);
  const prioLabel = (x)=>({gender:"남녀균형", score:"점수균형", trait:"특성균형"}[x] || x);
  const prioText = (Array.isArray(input.priorityOrder) ? input.priorityOrder : []).map(prioLabel).join(" > ");
  out.push(`반 수=${input.k}, 우선순위=${prioText || prioLabel(input.priority)}`);
  out.push("");
  classes.forEach((cls, idx)=>{
    out.push(`${idx+1}반`);
      cls.forEach((s,i)=>{
        const traits = input.traitNames.filter(t=>s.traits.has(t)).join(",");
      out.push(`${i+1}\t${s.display}\t${s.gender||""}\t${s.score??""}\t${traits}\t${s.sibGroup||""}`);
    });
    out.push("");
  });
  navigator.clipboard.writeText(out.join("\n")).catch(()=>{});
};

$("btnCSV").onclick = ()=>{
  if (!last) return;
  const {classes, input} = last;
  const gradePrefix = input.grade ? `${input.grade}-` : "";
  const rows = [[
    "기준",
    "이전반",
    "이전번호",
    "이전-반-번호",
    "학년",
    "반",
    "번호",
    "학년-반-번호",
    "이름",
    "성별",
    "점수",
    "특성",
    "쌍둥이그룹",
  ]];
  classes.forEach((cls, idx)=>{
    cls.forEach((s,i)=>{
      const traits = input.traitNames.filter(t=>s.traits.has(t)).join("|");
      const newClass = idx+1;
      const newNo = i+1;
      const g = input.grade || "";
      const gcn = `${gradePrefix}${newClass}-${newNo}`;
      const prev = (s.prevClass != null && s.prevNo != null) ? `${s.prevClass}-${s.prevNo}` : "";
      rows.push([
        input.grade ? "진급반 기준" : "현재반 기준",
        s.prevClass ?? "",
        s.prevNo ?? "",
        prev,
        g,
        String(newClass),
        String(newNo),
        gcn,
        s.display,
        s.gender||"",
        s.score??"",
        traits,
        s.sibGroup||"",
      ]);
    });
  });
  const csv = rows.map(r=>r.map(v=>{
    const x = String(v??"");
    if (/[",\n]/.test(x)) return `"${x.replaceAll('"','""')}"`;
    return x;
  }).join(",")).join("\n");
  // Excel on Windows often needs UTF-8 BOM to avoid mojibake.
  downloadText("반편성_결과.csv", "\ufeff" + csv, "text/csv;charset=utf-8");
};

/* ========= Generate ========= */
function setMsg(text, ok=false){
  const el = $("msg");
  if (!text){
    el.style.display="none";
    el.textContent="";
    el.classList.remove("ok");
    return;
  }
  el.style.display="block";
  el.textContent=text;
  el.classList.toggle("ok", !!ok);
}

$("btnGenerate").onclick = ()=>{
  try{
    setMsg("");
    const input = readInputs();

    // sanity: if gender unknown everywhere and user chose gender priority, warn
    const knownG = input.students.filter(s=>s.gender==="남"||s.gender==="여").length;
    if (knownG===0 && input.priority==="gender"){
      setMsg("남/여 정보가 거의 없습니다. '남학생/여학생 목록'을 넣거나 명렬표에 (남)/(여)를 붙이면 남녀 균등이 더 정확해져요.", false);
    }else{
      setMsg("생성 완료! 탭에서 반별 결과를 확인하세요.", true);
    }

    // multiple restarts and keep best (seed is internal/random)
    const tries = 6;
    let bestClasses = null, bestScore = Infinity;
    for (let t=0;t<tries;t++){
      const seed2 = String(Date.now()) + "-" + Math.floor(Math.random()*1e9) + "-" + t;
      const c = generateAssignment({...input, seed: seed2});
      const sc = evaluate(c, {...input, seed: seed2});
      if (sc < bestScore){
        bestScore = sc;
        bestClasses = c;
      }
    }

    const classes = bestClasses;
    last = {classes, input};
    render(classes, input);

    const el = $("result");
    if (el && el.scrollIntoView) el.scrollIntoView({behavior:"smooth", block:"start"});
  }catch(e){
    setMsg(e.message || String(e), false);
  }
};

$("btnReset").onclick = ()=>{
  ["roster","boys","girls","scores","avoidPairs","siblings"].forEach(id=>$(id).value="");
  $("inputType").value = "byClass";
  $("existingCount").value = "3";
  $("byClassArea").innerHTML = "";
  syncInputTypeUI();
  $("traitNames").value="ADHD,기초학력,특수교육대상,교우관계,사춘기";
  $("sheetBody").innerHTML = `<tr><td colspan="6" style="color:var(--muted);">명렬표를 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>`;
  $("twinBody").innerHTML = `<tr><td colspan="5" style="color:var(--muted);">쌍둥이 목록을 입력한 뒤 “표 생성/새로고침”을 눌러주세요.</td></tr>`;
  setMsg("");
  last=null;
  $("tabs").innerHTML="";
  $("tables").innerHTML="";
};

$("btnExample").onclick = ()=>{
  $("inputType").value = "byClass";
  $("existingCount").value = "3";
  syncInputTypeUI();
  $("k").value = 4;

  // Fill existing class rosters (names only)
  const tas = Array.from(document.querySelectorAll('#byClassArea textarea[data-existing-class]'));
  const t1 = tas.find(x=>x.dataset.existingClass==="1");
  const t2 = tas.find(x=>x.dataset.existingClass==="2");
  const t3 = tas.find(x=>x.dataset.existingClass==="3");
  if (t1) t1.value = `홍길동
김하나
박민수
이영희
최서준`;
  if (t2) t2.value = `정지우
오민재
유서연
장도윤
서하린`;
  if (t3) t3.value = `윤지호
배하은
한시우
조아라
김하나`;

  $("scores").value = `김하나 92
홍길동 88
박민수 75
이영희 91
최서준 83
정지우 77
오민재 86
유서연 80
장도윤 73
서하린 89
윤지호 78
배하은 85
한시우 72
조아라 84`;

  $("avoidPairs").value = `홍길동 - 박민수
김하나 - 이영희`;

  $("siblings").value = `유서연 - 서하린
김하나 - 김하나a`;

  $("traitNames").value = "ADHD,기초학력,특수교육대상,교우관계";
  buildTwinsTable();
  buildSheetFromRoster();

  // Fill a few traits in the sheet to demonstrate the dropdown UX.
  const traitMap = new Map([
    ["박민수", ["ADHD"]],
    ["오민재", ["ADHD"]],
    ["장도윤", ["기초학력"]],
    ["한시우", ["기초학력"]],
    ["윤지호", ["특수교육대상"]],
    ["홍길동", ["교우관계"]],
    ["조아라", ["교우관계"]],
  ]);
  const rows = Array.from(document.querySelectorAll("#sheetBody tr[data-student-id]"));
  for (const r of rows){
    const id = r.dataset.studentId || "";
    const base = id.replace(/[a-z]$/,"");
    const want = traitMap.get(base);
    if (!want) continue;
    const checks = Array.from(r.querySelectorAll('input[type="checkbox"][data-sheet-trait]'));
    for (const cb of checks){
      cb.checked = want.includes(cb.dataset.sheetTrait);
    }
  }

  setMsg("예시를 채웠습니다. '반편성 생성'을 눌러 확인해보세요.", true);
};
</script>
</body>
</html>
